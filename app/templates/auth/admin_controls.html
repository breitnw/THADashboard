{% extends 'base.html' %}

{% block header %}
    <h1>{% block title %}Admin Controls{% endblock %}</h1>
{% endblock %}

{% block content %}
    <h4>User Permissions</h4>
    <form method="post" action="{{ url_for("admin.update_users") }}">
        <table id="user-table">
            {% for data in user_data %}
                {% set disableSelect = false %}
                {% if (data.1 == "2" and g.user['permissions'] != "3") or (data.1 == "3") %}
                    {% set disableSelect = true %}
                {% endif %}

                <tr>
                    <td>{{ data.0 }}</td>
                    <td>
                        <label>
                            <select name="{{ data.0 }}" id="{{ data.0 }}_permissions" {% if disableSelect %} disabled {% endif %}>
                                <option value="0" {% if data.1 == "0" %} selected {% endif %}>None</option>
                                <option value="1" {% if data.1 == "1" %} selected {% endif %}>Editor</option>
                                <option value="2" {% if data.1 == "2" %} selected {% endif %}>Admin</option>
                                <option {% if data.1 == "3" %} selected {% endif %} disabled>Owner</option>
                            </select>
                        </label>
                    </td>
                    <td>
                        <a href="{{ url_for("admin.delete_user", user=data.0) }}">
                            <image class="icon{% if disableSelect %} delete-disabled{% endif %}" src="{{ url_for("static", filename="delete.svg") }}"></image>
                        </a>
                    </td>
                </tr>

            {% endfor %}
        </table>
        <input type="submit" value="Update Permissions">
    </form>

    <h4>Hubs</h4>
    <form method="post" action="{{ url_for("admin.update_hub") }}">
        <input type="text" name="hub-input" id="hub-input" hidden>
        <table id="hub-table">
            {% for info in hub_info %}
                <tr>
                    <td>
                        <span>{{ info.1 }}</span>
                    </td>
                    <td>
                        <span>{{ info.2 }}</span>
                    </td>
                    <td>
                        <image onclick="edit({{ loop.index - 1 }})" class="icon" src="{{ url_for("static", filename="edit.svg") }}"></image>
                        <button hidden type="submit" name="save" value="{{ info.0 }}" style="padding: 0; border: 0; background-color: transparent">
                            <img alt="save" src="{{ url_for("static", filename="save.svg") }}" class="icon">
                        </button>
                    </td>
                    <td>
                        <a href="{{ url_for("admin.delete_hub", idx=info.0) }}">
                            <image class="icon" src="{{ url_for("static", filename="delete.svg") }}"></image>
                        </a>
                    </td>
                </tr>
            {% endfor %}
        </table>
    </form>

    <form method="post" action="{{ url_for("admin.add_hub") }}">
        <span>
            <input type="text" name="new-hub-name" placeholder="Enter a new hub..." style="width: 10rem; display: inline;">
            <input type="text" name="new-hub-lat" placeholder="Latitude" style="width: 5rem; display: inline;">
            <input type="text" name="new-hub-long" placeholder="Longitude" style="width: 5rem; display: inline;">
            <button type="submit" style="width: 3rem; display: inline;">Add</button>
        </span>
    </form>

    <script>
        const HUB_TABLE = document.getElementById("hub-table");
        const HUB_INPUT = document.getElementById("hub-input");
        let prevRowIdx = -1;

        function edit(rowIdx) {
            const row = HUB_TABLE.children[0].children[rowIdx];

            const icon_td = row.children[2];
            icon_td.children[0].hidden = true;
            icon_td.children[1].hidden = false;

            const input_td = row.children[0];
            input_td.children[0].hidden = true;
            input_td.appendChild(HUB_INPUT);

            HUB_INPUT.value = input_td.children[0].innerHTML;
            HUB_INPUT.hidden = false;
            HUB_INPUT.select();

            if (prevRowIdx !== -1) {
                const prevRow = HUB_TABLE.children[0].children[prevRowIdx]

                const prev_index_td = prevRow.children[0]
                prev_index_td.children[0].hidden = false;

                const prev_icon_td = prevRow.children[2]
                prev_icon_td.children[0].hidden = false;
                prev_icon_td.children[1].hidden = true;
            }
            prevRowIdx = rowIdx;
        }
    </script>
{% endblock %}